---
title: "MILES"
author: "Franziska Lang"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3    
    toc_float: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render(
      inputFile, 
      encoding = encoding, 
      output_file = file.path(dirname(inputFile), "overview_miles.html")) }
      )
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = F)

date_today <- gsub("-", "", Sys.Date())
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(gtools)
library(rstatix)

#ADJUST THIS PATH!
setwd("./miles_publication/")


source("data_analysis/functions_evaluation_models.R")
theme_adju <- function(){
  theme_bw()+ 
  theme(axis.text=element_text(colour="black"))+ 
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
                  legend.position = "top",
        legend.justification="right",
      legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-10,-10,-10,-10),
      legend.title = element_blank(),
      legend.text = element_text(size = 6),
      title = element_text(size = 7),
      axis.text = element_text(size = 6),
          axis.title = element_text(size = 7))
}

theme_set(theme_adju())


path_plots <- "plots/"

export_plots <- F

```


## AIM

This code generates Figure 4 C-H and Supplemental Figure 5.  

Summary of MILES performance in context of the mutation type and mutation entity. 
Import Tuning results and calculate median ROC-AUC over 10x10 CV to determine the best hyper-parameter set that will represent performance of MILES on the respective data subset. 

## 1 PERFORMANCE WITH SD 


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

auc_overall_path <- read_delim("data_for_publication/MILES_results/MILES_best_models_with_SD.tsv")

paht_entity = c("MEL+RCC" = "miles_all", "MEL" = "miles_mel", "RCC" = "miles_rcc" )

# get full results of best MILES models
dat_best_models <- auc_overall_path$path_file %>%
  map(., read_delim, delim = "\t")
names(dat_best_models) <- auc_overall_path$path_file
dat_best_models <- bind_rows(dat_best_models, .id = "type")
dat_best_with_sd  <- dat_best_models %>%
  mutate(type = gsub("data_for_publication/MILES_results/", "" ,type )) %>%
  separate(type, sep= "/", into = c("mutation_type", "entity", "parameter")) %>%
  mutate(mutation_type = ifelse(mutation_type == "fusion_gene" , "Fusion gene" , mutation_type))%>%
  rowwise() %>%
  mutate(entity = names(paht_entity)[grepl(entity, paht_entity)]) %>%
  select(mutation_type, entity, auc) %>%
  rename(AUROC = auc)



```

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}


# get quantitative results
dat_quant_with_sd <- read_delim("data_for_publication/MILES_results/neoantigen_candidate_load_AUROC_with_SD.tsv")


```

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

# combine quantitative and qualitative results
dat_with_sd <- bind_rows(list("MILES" = dat_best_with_sd, "Neoantigen candidate load" = dat_quant_with_sd), .id = "type")

```

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}


p4c <- plot_miles_load(dat_with_sd, entity_ = "MEL", main = "MEL")
p4d <- plot_miles_load(dat_with_sd, entity_ = "RCC", main = "RCC")
p4e <-plot_miles_load(dat_with_sd, entity_ = "MEL+RCC", main = "MEL+RCC")

p_with_sd <- ggarrange(p4e, p4c, p4d,  ncol = 3, labels = c("C", "D", "E"))

```


## 3 PERFORMANCE WITHOUT SD 

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

auc_overall_path <- read_delim("data_for_publication/MILES_results/MILES_best_models_without_SD.tsv")

paht_entity = c("MEL+RCC" = "miles_all_wo_SD", "MEL" = "miles_mel_wo_SD", "RCC" = "miles_rcc_wo_SD" )

# get full results of best MILES models
dat_best_models <- auc_overall_path$path_file %>%
  map(., read_delim, delim = "\t")
names(dat_best_models) <- auc_overall_path$path_file
dat_best_models <- bind_rows(dat_best_models, .id = "type")
dat_best_without_sd  <- dat_best_models %>%
  mutate(type = gsub("data_for_publication/MILES_results/", "" ,type )) %>%
  separate(type, sep= "/", into = c("mutation_type", "entity", "parameter")) %>%
  mutate(mutation_type = ifelse(mutation_type == "fusion_gene" , "Fusion gene" , mutation_type))%>%
  rowwise() %>%
  mutate(entity = names(paht_entity)[grepl(entity, paht_entity)]) %>%
  select(mutation_type, entity, auc) %>%
  rename(AUROC = auc)



```


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}


# get quantitative results
dat_quant_without_sd <- read_delim("data_for_publication/MILES_results/neoantigen_candidate_load_AUROC_with_SD.tsv")


```

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

# combine quantitative and qualitative results
dat_without_sd <- bind_rows(list("MILES" = dat_best_without_sd, "Neoantigen candidate load" = dat_quant_without_sd), .id = "type")

```

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}


p4g <- plot_miles_load(dat_without_sd, entity_ = "MEL", main = "MEL")
p4h <- plot_miles_load(dat_without_sd, entity_ = "RCC", main = "RCC")
p4i <-plot_miles_load(dat_without_sd, entity_ = "MEL+RCC", main = "MEL+RCC")

p_without_sd <- ggarrange(p4i,p4g, p4h,  ncol = 3,labels = c("F", "G", "H"))

```


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

if(export_plots){
  nam <- paste0(path_plots, "/", date_today, "_Figure4.pdf")
  pdf(nam)
}
ggarrange(p_with_sd, p_without_sd, nrow = 2 )
if(export_plots){
dev.off()
}

```



## 3 FEATURE IMPORTANCE

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

# use this for supplemental figure 5 
dat_feature_importance <- read_delim("data_for_publication/MILES_results/feature_importance.tsv")

# get quantitative results
ps5a <- plot_importance(importance_all, type = "MEL+RCC")
ps5b <- plot_importance(importance_all, type = "MEL")
ps5c <- plot_importance(importance_all, type = "RCC")

if(export_plots){
  nam <- paste0(path_plots, "/", date_today, "_Supplemental_Figure5.pdf")
  pdf(nam)
}
ggarrange(ps5a, ps5b, ps5c, ncol = 2, nrow = 2, labels = c("A", "B", "C") )
if(export_plots){
dev.off()
}

```

