---
title: "MILES"
author: "Franziska Lang"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3    
    toc_float: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render(
      inputFile, 
      encoding = encoding, 
      output_file = file.path(dirname(inputFile), "miles_random_models.html")) }
      )
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = F)

date_today <- gsub("-", "", Sys.Date())
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(gtools)

# ADJUST THIS PATH 
setwd("./miles_publication/")
theme_adju <- function(){
  theme_bw()+ 
  theme(axis.text=element_text(colour="black"))+ 
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
                  legend.position = "top",
        legend.justification="right",
      legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-10,-10,-10,-10),
      legend.title = element_blank(),
      legend.text = element_text(size = 6),
      title = element_text(size = 7),
      axis.text = element_text(size = 6),
          axis.title = element_text(size = 7))
}

theme_set(theme_adju())

source("data_analysis/functions_evaluation_models.R")
theme_set(theme_bw())

path_plots <- "plots/"

export_plots <- F

export_table <- F
```

This code generates Supplemental Figure 3. 

## Hyperparameter of best models 


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

auc_overall_path <- read_delim("data_for_publication/MILES_results/MILES_best_models_with_SD.tsv")

col_mut <- c("SNV" = "#88CCEE","INDEL" = "#CC6677", "Fusion gene" = "#DDCC77","combined" = "#117733")

ps3a <- auc_overall_path %>%
  ggplot(aes(sigma2, c, color = class, shape = entity))+
  scale_color_manual(values = col_mut)+
  scale_x_continuous(trans = "log10")+
  geom_point( size = 5)




```


## Comparison best to random model 

Neoantigen candidates were randomized across patients and 10x10 CV was repeated with best hyperparameter setting for the respective setting. Here, performance of the original approach is compared to the random model . 


### 1.1 MEL + RCC

#### 1.1.1 SNVs

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

path_random = "data_for_publication/MILES_results/SNV/randomized_data/miles_10000_0.1.tsv"
path_best = "data_for_publication/MILES_results/SNV/miles_all/miles_10000_0.1.tsv"

p1 <- compare_random_best(path_random, path_best, class = "SNV")


```

#### 1.1.2 fusion genes


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

path_random = "data_for_publication/MILES_results/fusion_gene/randomized_data/miles_1000_0.4.tsv"
path_best = "data_for_publication/MILES_results/fusion_gene/miles_all/miles_1000_0.4.tsv"
p2 <- compare_random_best(path_random, path_best, class = "Fusion gene")


```


#### 1.1.3 combined


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}


path_random = "data_for_publication/MILES_results/combined/randomized_data/miles_5000_0.1.tsv"
path_best = "data_for_publication/MILES_results/combined/miles_all/miles_5000_0.1.tsv"

p3 <- compare_random_best(path_random, path_best, class = "Combined")


```



### 1.1.4 INDEL

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

path_random = "data_for_publication/MILES_results/INDEL/randomized_data/miles_500000_0.9.tsv"
path_best = "data_for_publication/MILES_results/INDEL/miles_all/miles_500000_0.9.tsv"


p4 <- compare_random_best(path_random, path_best, class = "INDEL")

```


### 1.2 MEL

#### 1.2.1 SNVs

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

path_random = "data_for_publication/MILES_results/SNV/randomized_data_mel/miles_10000000_0.1.tsv"
path_best = "data_for_publication/MILES_results/SNV/miles_mel/miles_10000000_0.1.tsv"

p5 <- compare_random_best(path_random, path_best, class = "MEL : SNV")


```

#### 1.2.2 combined


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

path_random = "data_for_publication/MILES_results/combined/randomized_data_mel/miles_500000_0.1.tsv"
path_best = "data_for_publication/MILES_results/combined/miles_mel/miles_500000_0.1.tsv"

p6 <- compare_random_best(path_random, path_best, class = "MEL : Combined")

```



### 1.2.3 INDEL

```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}

path_random = "data_for_publication/MILES_results/INDEL/randomized_data_mel/miles_500000_0.6.tsv"
path_best = "data_for_publication/MILES_results/INDEL/miles_mel/miles_500000_0.6.tsv"

p7 <- compare_random_best(path_random, path_best, class = "MEL : INDEL")

```



## Summary


```{r , echo=FALSE, message=FALSE, warning = FALSE, results=FALSE}


if(export_plots){
   f <- paste0(path_plots, date_today, "_Supplemental_Figure3.pdf")
  pdf(f)
}
ggarrange(ps3a, p1, p2, p3, p4, p5, p6, p7 ,
          labels = c("A", "B", "C", "D", "E", "F", "G","H"),
          ncol = 2, nrow = 4)  
if(export_plots){
   dev.off()
}

```
